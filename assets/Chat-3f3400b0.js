import{_ as S,u as D,r as E,b as j,d as C,g as F,o as h,c as p,a,t as m,F as T,e as B,w as N,v as V,f as J,h as K}from"./index-36a0d909.js";function P(_){const e=_.split(`

`),n=[];return e.forEach(t=>{if(t){const r=t.split(`
`);let u=null,l="";r.forEach(o=>{o.startsWith("event:")?u=o.slice(6).trim():o.startsWith("data:")&&(l+=o.slice(5).trim())});try{const o=x(l);n.push({event:u,data:o})}catch{n.push({event:u,data:l})}}}),n}function x(_){try{const e=JSON.parse(_);if(typeof e=="object"&&e!==null)for(const n in e)Object.prototype.hasOwnProperty.call(e,n)&&(e[n]=x(e[n]));return e}catch{return _}}const R={class:"chat-body"},W={class:"chat"},q={class:"chat-header"},U=["src"],$={class:"chat-content"},z={key:0,class:"chat-item-user"},A={key:1,class:"chat-item-agent"},G={class:"chat-input"},H={__name:"Chat",setup(_){const e=D(),{bot_id:n}=e.query,t=E({agentInfo:{bot_id:"",icon_url:"",name:""},chatMessageList:[]}),r=j("");C(()=>{u()});const u=async()=>{const i=await F({bot_id:n});Object.assign(t.agentInfo,i.data)},l=async()=>{if(!r.value)return;const{bot_id:i}=t.agentInfo,d=r.value;t.chatMessageList.push({id:new Date().getTime(),content:d,type:"user"}),r.value="",K({bot_id:i,user_id:"admin",stream:!0,auto_save_history:!0,additional_messages:[{role:"user",content:d,content_type:"text"}]}).then(async g=>{const c=g.data.getReader(),I=new TextDecoder("utf-8");let f=[];for(;;){const{done:L,value:M}=await c.read();if(L){console.log("数据流接收完成");break}const k=P(I.decode(M));f.push(k),console.log("stream_list:",f.flat());const{chat_agent_message_id:y,answer_data_content:w}=o(f.flat()),v={};v.id=y,v.content=w;const b=t.chatMessageList.findIndex(O=>O.id===y);b>-1?t.chatMessageList[b].content=w:t.chatMessageList.push(v),console.log(t.chatMessageList)}})},o=i=>{const d=i.filter(c=>c.event==="conversation.chat.created")[0].data.id,s=i.filter(c=>c.event==="conversation.message.delta").map(c=>c.data);console.log("answer_data_list:",s);const g=s.map(c=>c.content).join("");return console.log("answer_data_content:",g),{chat_agent_message_id:d,answer_data_content:g}};return(i,d)=>(h(),p("div",R,[a("div",W,[a("div",q,[a("img",{src:t.agentInfo.icon_url,alt:"icon"},null,8,U),a("p",null,m(t.agentInfo.name),1)]),a("div",$,[(h(!0),p(T,null,B(t.chatMessageList,s=>(h(),p("div",{key:s.id,class:"chat-item"},[s.type==="user"?(h(),p("div",z,[a("p",null,m(s.content),1)])):(h(),p("div",A,[a("p",null,m(s.content),1)]))]))),128))]),a("div",G,[N(a("input",{"onUpdate:modelValue":d[0]||(d[0]=s=>r.value=s),onKeyup:J(l,["enter"])},null,544),[[V,r.value]]),a("button",{onClick:l},"发送")])])]))}},X=S(H,[["__scopeId","data-v-314bdfd5"]]);export{X as default};
